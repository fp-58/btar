(()=>{const t=512;class e{#t=new Map;#e=[];addFile(t,e,i){t.endsWith("/")&&(t=t.substring(0,t.length-1));const r=t.lastIndexOf("/"),o=n(t.substring(r+1),i?.t??420,i?.i??0,i?.o??0,e.size,e.lastModified,-1,0,"",0,i?.l??"",i?.u??"",0,0,t.substring(0,r+1));this.#t.set(t,this.#e.length),this.#e.push({header:o,content:e})}#n(t,e,i,r){let o=e.lastIndexOf("/");o===e.length-1&&(o=e.substring(0,o).lastIndexOf("/"));const a=n(e.substring(o+1),r?.t??420,r?.i??0,r?.o??0,0,r?.h??Date.now(),-1,t,i,0,r?.l??"",r?.u??"",0,0,e.substring(0,o+1));this.#t.set(e,this.#e.length),this.#e.push({header:a})}addHardlink(t,e,n){this.#n(1,t,e,n)}addSymlink(t,e,n){this.#n(2,t,e,n)}addDir(t,e){let i=t.lastIndexOf("/");i===t.length-1?i=t.substring(0,i).lastIndexOf("/"):t+="/";const r=n(t.substring(i+1),e?.t??509,e?.i??0,e?.o??0,0,e?.h??Date.now(),-1,5,"",0,e?.l??"",e?.u??"",0,0,t.substring(0,i+1));this.#t.set(t,this.#e.length),this.#e.push({header:r})}static async fromFile(i){let r=0;const o=new e;for(let e=await l();e;e=await l()){let n=r*t,s=n+e.size;if(i.size<s)throw Error(`Malformed archive: Expected size ${s}, got size ${i.size}`);let c,f=e.prefix+e.name;if(f.endsWith("/")){let t=f.substring(0,f.length-1),e=t.lastIndexOf("/");c=t.substring(e)}else{let t=f.lastIndexOf("/");c=f.substring(t)}const l=new a([i.slice(n,s)],c,f,{lastModified:e.lastModified,endings:"transparent"});o.#t.set(f,o.#e.length),o.#e.push({header:e,content:l}),r+=Math.ceil(e.size/t)}async function l(){const e=await async function(){const e=await d();i.size-r*t>-512&&r++;return e}();if(f(e)){if(f(await d()))return null}return n(s(e,0,100),c(e,100,8),c(e,108,8),c(e,116,8),c(e,124,12),c(e,136,12),c(e,148,8),c(e,156,1),s(e,157,100),c(e,263,3),s(e,265,32),s(e,297,32),c(e,329,8),c(e,337,8),s(e,345,155))}async function d(){let e=r*r,n=e+t;if(i.size<e)return new Uint8Array(t);if(i.size<n){const n=new Uint8Array(t),r=i.slice(e),o=new Uint8Array(await r.arrayBuffer());return n.set(o),n}{const t=i.slice(e,n);return new Uint8Array(await t.arrayBuffer())}}}trim(){let t=new Set;for(let e=this.#e.length-1;e>=0;e--){const n=this.#e[e],i=n.header.prefix+n.header.name;t.has(i)?(this.#e.splice(e,1),e++):t.add(i)}const e=this.#e.map(((t,e)=>[t.header.prefix+t.header.name,e]));this.#t=new Map(e)}toBlob(){const e=[];for(const n of this.#e){const r=new Uint8Array(t);if(i(n.header,r),e.push(r),n.content){e.push(n.content);let i=n.content.size%t;if(i>0){const n=new ArrayBuffer(t-i);e.push(n)}}}const n=new ArrayBuffer(1024);return e.push(n),new Blob(e,{endings:"transparent",type:"application/x-tar"})}}function n(t,e,n,r,o,a,s,c,f,l,d,u,h,w,y){const p={name:t,mode:e,uid:n,gid:r,size:o,lastModified:a,checksum:s,typeflag:c,linkname:f,version:l,uname:d,gname:u,devmajor:h,devminor:w,prefix:y};if(-1===s){const t=new Uint8Array(500);i(p,t);const e=21;p.checksum=function(t,e){const n=(2<<e)-1,i=148,r=156;let o=0;for(let e=0;e<t.length;e++){let a=t[e];i<=e&&e<=r&&(a=32),o=o+a&n}return o}(t,e)}return p}function i(t,e,n=0){e=e.subarray(n,n+500),r(t.name,e,0,100),o(t.mode,e,100,8),o(t.uid,e,108,8),o(t.gid,e,116,8),o(t.size,e,124,12),o(t.lastModified,e,136,12),o(t.checksum,e,148,8),o(t.typeflag,e,156,1),r(t.linkname,e,157,100),r("ustar",e,257,6),o(63&t.version,e,263,3),r(t.uname,e,265,32),r(t.gname,e,297,32),-1===t.devmajor?e.fill(0,329,337):o(t.devmajor,e,329,8),-1===t.devminor?e.fill(0,337,345):o(t.devminor,e,337,8),r(t.prefix,e,345,155)}function r(t,e,n=0,i=e.length-n){e=e.subarray(n,n+i);const r=(new TextEncoder).encodeInto(t,e).written;r<i&&(e[r]=0)}function o(t,e,n=0,i=e.length-n){Math.ceil(Math.log2(t)/3)<i&&(e[n+--i]=0);for(let r=i-1;r>=n;r--){const n=48+(7&t);t>>=3,e[r]=n}}class a extends File{#i;constructor(t,e,n,i){super(t,e,i),this.#i=n}get webkitRelativePath(){return this.#i}}function s(t,e=0,n=t.length-e){t=new Uint8Array(t,e,n);const i=new TextDecoder;for(let e=0;e<n;e++)if(0===t[e]){t=t.subarray(0,e);break}return i.decode(t)}function c(t,e,n){t=new Uint8Array(t,e,n);let i=0;for(const e of t){if(0===e)break;i<<=3,e<49||55<e||(i|=e-48)}return i}function f(t){return t.every((t=>0===t))}"function"==typeof define&&define.amd?define((function(){return{TarArchive:e}})):"object"==typeof module&&module?module.exports.TarArchive=e:"object"==typeof exports&&exports?exports.TarArchive=e:"object"==typeof window&&window?window.TarArchive=e:globalThis.TarArchive=e})();