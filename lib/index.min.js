!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).btar={})}(this,(function(t){"use strict";const e=512,n=68719476735,i=420;class r{#t=new Map;#e=[];addFile(t,e,n){const r=s(t=o(t)),c=a(r.t,n?.mode??i,n?.uid??0,n?.gid??0,e.size,e.lastModified,void 0,0,"",0,n?.uname??"",n?.gname??"",void 0,void 0,r.i);this.#t.set(t,this.#e.length),this.#e.push({header:c,content:e})}#n(t,e,n,r){const c=s(e=o(e));let d=n.endsWith("/");n=o(e),d&&(n+="/");const f=a(c.t,r?.mode??i,r?.uid??0,r?.gid??0,0,r?.lastModified??Date.now(),void 0,t,n,0,r?.uname??"",r?.gname??"",void 0,void 0,c.i);this.#t.set(e,this.#e.length),this.#e.push({header:f})}addHardlink(t,e,n){this.#n(1,t,e,n)}addSymlink(t,e,n){this.#n(2,t,e,n)}addDir(t,e){const n=s(t=o(t)+"/"),i=a(n.t,e?.mode??509,e?.uid??0,e?.gid??0,0,e?.lastModified??Date.now(),void 0,5,"",0,e?.uname??"",e?.gname??"",void 0,void 0,n.i);this.#t.set(t,this.#e.length),this.#e.push({header:i})}#i(t,e,n,r,c){const d=s(e=o(e)),f=a(d.t,c?.mode??i,c?.uid??0,c?.gid??0,0,c?.lastModified??Date.now(),void 0,t,"",0,c?.uname??"",c?.gname??"",n,r,d.i);this.#t.set(e,this.#e.length),this.#e.push({header:f})}addCharDevice(t,e,n,i){this.#i(3,t,e,n,i)}addBlockDevice(t,e,n,i){this.#i(4,t,e,n,i)}addFIFO(t,e){const n=s(t=o(t)),r=a(n.t,e?.mode??i,e?.uid??0,e?.gid??0,0,e?.lastModified??Date.now(),void 0,6,"",0,e?.uname??"",e?.gname??"",void 0,void 0,n.i);this.#t.set(t,this.#e.length),this.#e.push({header:r})}get length(){return this.#e.length}[Symbol.iterator](){return this.entries()}*entries(){for(let t=0;t<this.#e.length;t++)yield this.entryAt(t)}entryAt(t){const e=this.#e[t];if(!e)return;const n=Object.assign({},e.header);return e.content?{header:n,content:e.content}:{header:n}}indexOf(t){let e=this.#t.get(t);if(void 0===e){for(let e=this.#e.length-1;e>=0;e--){const n=this.#e[e];if(n.header.prefix+n.header.name===t)return this.#t.set(t,e),e}return-1}return e}removeAt(t){if(!(t<0||this.#e.length<=t)){this.#e.splice(t,1);for(const[e,n]of this.#t)n<t||this.#t.set(e,n-1)}}removeEntry(t){for(let e=this.#t.get(t)??this.#e.length-1;e>=0;e--){const n=this.#e[e];n.header.prefix+n.header.name===t&&this.removeAt(e)}}static async fromBlob(t){let n=0;const i=new r;for(let r=await o();r;r=await o()){let o=n*e,s=o+r.size;if(t.size<s)throw Error(`Malformed archive: Expected size ${s}, got size ${t.size}`);3!==r.typeflag&&4!==r.typeflag&&(r.devmajor=r.devminor=void 0);let a=r.prefix+r.name;const c=new File([t.slice(o,s)],a,{lastModified:r.lastModified,endings:"transparent"});i.#t.set(a,i.#e.length),i.#e.push({header:r,content:c}),n+=Math.ceil(r.size/e)}return i;async function o(){const i=await async function(){const i=await s();t.size-n*e>-512&&n++;return i}();if(u(i)){if(u(await s()))return null}return a(h(i,0,100),l(i,100,8),l(i,108,8),l(i,116,8),l(i,124,12),l(i,136,12),l(i,148,8),l(i,156,1),h(i,157,100),l(i,263,3),h(i,265,32),h(i,297,32),l(i,329,8),l(i,337,8),h(i,345,155))}async function s(){let i=n*n,r=i+e;if(t.size<i)return new Uint8Array(e);if(t.size<r){const n=new Uint8Array(e),r=t.slice(i),o=new Uint8Array(await r.arrayBuffer());return n.set(o),n}{const e=t.slice(i,r);return new Uint8Array(await e.arrayBuffer())}}}trim(){let t=new Set;for(let e=this.#e.length-1;e>=0;e--){const n=this.#e[e],i=n.header.prefix+n.header.name;t.has(i)?(this.#e.splice(e,1),e++):t.add(i)}const e=this.#e.map(((t,e)=>[t.header.prefix+t.header.name,e]));this.#t=new Map(e)}toBlob(){const t=[];for(const n of this.#e){const i=new Uint8Array(e);if(c(n.header,i),t.push(i),n.content){t.push(n.content);let i=n.content.size%e;if(i>0){const n=new ArrayBuffer(e-i);t.push(n)}}}const n=new ArrayBuffer(1024);return t.push(n),new Blob(t,{endings:"transparent",type:"application/x-tar"})}}function o(t){const e=t.split("/");for(let t=0;t<e.length;t++)switch(e[t]){case"":case".":e.splice(t,1),t--;break;case"..":t>=1&&(e.splice(t-1,2),t-=2)}return e.join("/")}function s(t){if(t.length>255)throw Error(`Path is too long: ${t.length} > 255`);let e=t,n="";if(t.length>100){let i=t.length-100;e=t.substring(i),n=t.substring(0,i)}return{t:e,i:n}}function a(t,e,i,r,o,s,a,d,f,h,l,u,w,v,y){(s=Math.floor(s/1e3))>n&&(s=n);const p={name:t,mode:e,uid:i,gid:r,size:o,lastModified:s,checksum:a??0,typeflag:d,linkname:f,version:h,uname:l,gname:u,devmajor:w,devminor:v,prefix:y};if(void 0===a){const t=new Uint8Array(500);c(p,t);const e=21;p.checksum=function(t,e){const n=(2<<e)-1,i=148,r=155;let o=0;for(let e=0;e<t.length;e++){let s=t[e];i<=e&&e<=r&&(s=32),o=o+s&n}return o}(t,e)}return p}function c(t,e,n=0){e=e.subarray(n,n+500),d(t.name,e,0,100),f(t.mode,e,100,8),f(t.uid,e,108,8),f(t.gid,e,116,8),f(t.size,e,124,12),f(t.lastModified,e,136,12),f(t.checksum,e,148,7),e[155]=32,f(t.typeflag,e,156,1),d(t.linkname,e,157,100),d("ustar",e,257,6),f(63&t.version,e,263,3),d(t.uname,e,265,32),d(t.gname,e,297,32),void 0===t.devmajor?e.fill(0,329,337):f(t.devmajor,e,329,8),void 0===t.devminor?e.fill(0,337,345):f(t.devminor,e,337,8),d(t.prefix,e,345,155)}function d(t,e,n=0,i=e.length-n){e=e.subarray(n,n+i);const r=(new TextEncoder).encodeInto(t,e).written;r<i&&(e[r]=0)}function f(t,e,n=0,i=e.length-n){Math.max(1,Math.ceil(Math.log2(t)/3))<i&&(e[n+--i]=0);for(let r=n+i-1;r>=n;r--){const n=48+(7&t);t>>=3,e[r]=n}}function h(t,e=0,n=t.length-e){t=new Uint8Array(t,e,n);const i=new TextDecoder;for(let e=0;e<n;e++)if(0===t[e]){t=t.subarray(0,e);break}return i.decode(t)}function l(t,e,n){t=new Uint8Array(t,e,n);let i=0;for(const e of t){if(0===e)break;i<<=3,e<49||55<e||(i|=e-48)}return i}function u(t){return t.every((t=>0===t))}t.TarArchive=r}));